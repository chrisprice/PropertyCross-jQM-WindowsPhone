(function(){function G(c){this.template="favouritesView";this.factoryName="FavouritesViewModel";this.properties=c.favourites}function H(c){this.factoryName="GeolocationViewModel";this.displayString=this.lon=this.lat=void 0;this.totalResults=0;this.initialise=function(a,b){this.lat=a;this.lon=b;this.displayString=a.toFixed(2)+", "+b.toFixed(2)};this.executeSearch=function(a,b,d){c.propertyDataSource.findPropertiesByCoordinate(this.lat,this.lon,a,b,d)}}function I(c){this.factoryName="LocationViewModel";
this.displayString=this.searchString=void 0;this.totalResults=0;this.initialise=function(a){this.displayString=this.searchString=a};this.initialiseDisambiguated=function(a){this.searchString=a.placeName;this.displayString=a.longTitle};this.executeSearch=function(a,b,d){c.propertyDataSource.findProperties(this.searchString,a,b,d)}}function J(c){var a=!0,b=this;this.template="propertySearchView";this.factoryName="PropertySearchViewModel";this.searchDisplayString=s.observable("");this.userMessage=s.observable();
this.searchLocation=new B(c);this.isSearchEnabled=s.observable(!0);this.locationEnabled=s.observable(!0);this.locations=s.observableArray();this.recentSearches=c.recentSearches;this.searchDisplayString.subscribe(function(){if(a){var d=new B(c);d.initialise(b.searchDisplayString());b.searchLocation=d}});this.executeSearch=function(){b.userMessage("");b.isSearchEnabled(!1);this.searchLocation.executeSearch(1,function(a){a.responseCode===K.propertiesFound?null===a.totalResults?b.userMessage("There were no properties found for the given location."):
(b.searchLocation.totalResults=a.totalResults,c.addToRecentSearches(b.searchLocation),c.navigateToSearchResults(b.searchLocation,a)):a.responseCode===K.ambiguousLocation?(b.locations.removeAll(),a.data.forEach(function(a){var d=new B(c);d.initialiseDisambiguated(a);b.locations.push(d)})):b.userMessage("The location given was not recognised.");b.isSearchEnabled(!0)},function(){b.userMessage("An error occurred while searching. Please check your network connection and try again.");b.isSearchEnabled(!0)})};
this.searchMyLocation=function(){function d(d){var f=new R(c);f.initialise(d.coords.latitude,d.coords.longitude);a=!1;b.searchLocation=f;b.searchDisplayString(f.displayString);a=!0;b.executeSearch()}function f(){b.userMessage("Unable to detect current location. Please ensure location is turned on in your phone settings and try again.")}!1===this.locationEnabled()?b.userMessage("The use of location is currently disabled. Please enable via the 'about' page."):navigator.geolocation.getCurrentPosition(d,
f)};this.selectLocation=function(){a=!1;b.searchLocation=this;b.searchDisplayString(this.displayString);a=!0;b.locations.removeAll();b.executeSearch()};this.viewFavourites=function(){c.navigateToFavourites(this.favourites)}}function C(c){this.template="propertyView";this.factoryName="PropertyViewModel";this.price=e.observable();this.bedrooms=e.observable();this.bathrooms=e.observable();this.propertyType=e.observable();this.thumbnailUrl=e.observable();this.guid=e.observable();this.summary=e.observable();
this.title=e.observable();this.isFavourite=e.computed(function(){return!!c.getFavouriteByGuid(this.guid())},this);this.stats=e.computed(function(){var a=this.bedrooms()+" bed "+this.propertyType(),b=this.bathrooms();b&&(a+=", "+b+" "+(1<b?"bathrooms":"bathroom"));return a},this);this.initialize=function(a){this.guid(e.utils.unwrapObservable(a.guid));this.price(e.utils.unwrapObservable(a.price));this.bedrooms(e.utils.unwrapObservable(a.bedrooms));this.bathrooms(e.utils.unwrapObservable(a.bathrooms));
this.propertyType(e.utils.unwrapObservable(a.propertyType));this.thumbnailUrl(e.utils.unwrapObservable(a.thumbnailUrl));this.summary(e.utils.unwrapObservable(a.summary));if(a=e.utils.unwrapObservable(a.title))a=a.split(", "),2<=a.length&&this.title(a[0]+", "+a[1])};this.select=function(){c.navigateToProperty(this)};this.addToFavourites=function(){var a=new C(c);a.initialize(this);c.addToFavourites(a)}}function L(c){var a=this;this.template="searchResultsView";this.factoryName="SearchResultsViewModel";
this.isLoading=t.observable(!1);this.totalResults=t.observable();this.pageNumber=t.observable(1);this.searchLocation=t.observable(void 0);this.properties=t.observableArray();this.initialize=function(b,d){this.properties(d.data.map(function(a){var d=new M(c);d.initialize(a);return d}));a.searchLocation(b);a.totalResults(d.totalResults)};this.loadMore=function(){this.pageNumber(this.pageNumber()+1);this.isLoading(!0);this.searchLocation().executeSearch(this.pageNumber(),function(b){a.isLoading(!1);
b.data.forEach(function(d){var b=new M(c);b.initialize(d);a.properties.push(b)});a.pageNumber(a.pageNumber()+1)})}}function N(){var c={};q.currentViewModel.subscribe(function(a){var b=q.currentView(),j=c[b];j||(j=c[b]=y("#"+b),z.applyBindings(a,j[0]));y.mobile.changePage(j)});q.backButtonRequired.subscribe(function(a){function b(){c||q.back()}var c=!0;a?document.addEventListener("backbutton",b,!1):document.removeEventListener("backbutton",b,!1);c=!1});q.state.subscribe(function(a){localStorage.setItem("appState",
a)});var a=localStorage.getItem("appState");if(a)try{q.setState(a)}catch(b){console.warn("Failed to load state",b)}q.navigateToHome()}var p={};p.module$exports=jQuery;p.module$exports&&(p=p.module$exports);var k={};k.module$exports=window.ko;k.module$exports&&(k=k.module$exports);var g={module$exports:function(){function c(b,d,c,j){a.jsonp({dataType:"jsonp",data:d,url:b,timeout:5E3,success:function(a){c(a)},error:function(a,b,d){j("datasource error ["+b+"] ["+d+"]")}})}var a=p;this.findProperties=
function(a,d,f,j){c("http://api.nestoria.co.uk/api",{country:"uk",pretty:"1",action:"search_listings",encoding:"json",listing_type:"buy",page:d,place_name:a,callback:"_jqjsp"},f,j)};this.findPropertiesByCoordinate=function(a,d,f,j,e){c("http://api.nestoria.co.uk/api",{country:"uk",pretty:"1",action:"search_listings",encoding:"json",listing_type:"buy",page:f,centre_point:a+","+d,callback:"_jqjsp"},j,e)}}};g.module$exports&&(g=g.module$exports);var l={module$exports:function(c){this.longTitle=c.longTitle;
this.placeName=c.placeName}};l.module$exports&&(l=l.module$exports);var m={module$exports:function(c){this.guid=c.guid;this.price=c.price;this.bedrooms=c.bedrooms;this.bathrooms=c.bathrooms;this.propertyType=c.propertyType;this.title=c.title;this.thumbnailUrl=c.thumbnailUrl;this.imgUrl=c.imgUrl;this.summary=c.summary}};m.module$exports&&(m=m.module$exports);var A={module$exports:function(c){this.responseCode=c.responseCode;this.data=c.data;this.totalResults=c.totalResults;this.pageNumber=c.pageNumber}};
A.module$exports&&(A=A.module$exports);var h={module$exports:{propertiesFound:1,ambiguousLocation:2,unknownLocation:3}};h.module$exports&&(h=h.module$exports);var u={},S=m,T=l,D=A,E=h,U=g;u.module$exports=function(){function c(a){var b=[],d=[],c=a.response.application_response_code,j,e;"100"===c||"101"===c||"110"===c?(a.response.listings.forEach(function(a){j=new S({guid:a.guid,title:a.title,price:a.price_formatted.substr(0,a.price_formatted.lastIndexOf(" ")),bedrooms:a.bedroom_number,bathrooms:a.bathroom_number,
propertyType:a.property_type,thumbnailUrl:a.img_url,summary:a.summary});b.push(j)}),a=new D({responseCode:E.propertiesFound,data:b,totalResults:a.response.total_results,pageNumber:a.response.page})):"200"===c||"202"===c?(a.response.locations.forEach(function(a){e=new T({longTitle:a.long_title,placeName:a.place_name,title:a.title});d.push(e)}),a=new D({responseCode:E.ambiguousLocation,data:d})):a=new D({responseCode:E.unknownLocation});return a}this.jsonDataSource=new U;this.findProperties=function(a,
b,d,f){this.jsonDataSource.findProperties(a,b,function(a){d(c(a))},f)};this.findPropertiesByCoordinate=function(a,b,d,f,e){this.jsonDataSource.findPropertiesByCoordinate(a,b,d,function(a){f(c(a))},e)}};u.module$exports&&(u=u.module$exports);var g={},F=p,O=k,P={};g.module$exports={registerFactory:function(c,a){P[c]=a},hydrateObject:function a(b,d){if(!F.isPlainObject(d))return d;var f,e,g,h=new P[d.factoryName](b);for(f in d)if(g=d[f],O.isWriteableObservable(h[f]))if(e=O.utils.unwrapObservable(h[f]),
F.isArray(e))_.each(g,function(d){h[f].push(a(b,d))});else h[f](g);else F.isFunction(h[f])||(h[f]=a(b,g));return h}};g.module$exports&&(g=g.module$exports);var v={};g.registerFactory("FavouritesViewModel",G);v.module$exports=G;v.module$exports&&(v=v.module$exports);l={};g.registerFactory("GeolocationViewModel",H);l.module$exports=H;l.module$exports&&(l=l.module$exports);m={};g.registerFactory("LocationViewModel",I);m.module$exports=I;m.module$exports&&(m=m.module$exports);var w={},s=k,K=h,B=m,R=l;
g.registerFactory("PropertySearchViewModel",J);w.module$exports=J;w.module$exports&&(w=w.module$exports);var r={},e=k;g.registerFactory("PropertyViewModel",C);r.module$exports=C;r.module$exports&&(r=r.module$exports);var x={},t=k,M=r;g.registerFactory("SearchResultsViewModel",L);x.module$exports=L;x.module$exports&&(x=x.module$exports);var h={},V=p,n=k,Q=g;h.module$exports=function(){var a=this,b={};this.propertyDataSource=new u;this.favourites=n.observableArray();this.recentSearches=n.observableArray();
this.maxRecentSearch=5;this.viewModelBackStack=n.observableArray();this.backButtonRequired=n.computed(function(){return 1<this.viewModelBackStack().length},this);this.currentViewModel=n.computed(function(){return this.viewModelBackStack()[this.viewModelBackStack().length-1]},this);this.currentView=n.computed(function(){var a=this.currentViewModel();return a?a.template:""},this);this.navigateTo=function(a){this.viewModelBackStack.push(a)};this.navigateToHome=function(){this.viewModelBackStack.push(b.propertySearch)};
this.navigateToSearchResults=function(a,f){b.searchResults.initialize(a,f);this.navigateTo(b.searchResults)};this.navigateToProperty=function(a){b.property.initialize(a);this.navigateTo(b.property)};this.navigateToFavourites=function(){this.navigateTo(b.favourites)};this.back=function(){this.viewModelBackStack.pop()};this.setState=function(b){if(b=V.parseJSON(b))b.favourites&&b.favourites.forEach(function(b){a.favourites.push(Q.hydrateObject(a,b))}),b.recentSearches&&b.recentSearches.forEach(function(b){a.recentSearches.push(Q.hydrateObject(a,
b))})};this.state=n.computed(function(){var a={recentSearches:this.recentSearches(),favourites:this.favourites()};return n.toJSON(a)},this);this.getFavouriteByGuid=function(a){return n.utils.arrayFirst(this.favourites(),function(b){return b.guid()===a})};this.addToFavourites=function(a){var b=this.getFavouriteByGuid(a.guid());b?this.favourites.remove(b):this.favourites.push(a)};this.addToRecentSearches=function(a){var b=n.utils.arrayFirst(this.recentSearches(),function(b){return b.displayString===
a.displayString});this.recentSearches.remove(b);this.recentSearches.unshift(a);this.recentSearches().length>this.maxRecentSearch&&this.recentSearches.pop()};b.searchResults=new x(this);b.property=new r(this);b.favourites=new v(this);b.propertySearch=new w(this)};h.module$exports&&(h=h.module$exports);var y=p,z=k,q=new h;z.virtualElements.allowedBindings.updateListviewOnChange=!0;z.bindingHandlers.updateListviewOnChange={update:function(a,b){z.utils.unwrapObservable(b());var d=y(a).parents().andSelf().filter("[data-role='listview']");
d.data("mobile-listview")&&d.listview("refresh")}};/\/www\//.test(location)?document.addEventListener("deviceready",N,!1):y(N)})();
